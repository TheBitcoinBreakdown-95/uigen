name: Claude Auto Review & Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      task:
        description: 'Custom task for Claude to perform'
        required: false
        default: 'Review the code and fix any issues'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Project Setup
        run: |
          # Install dependencies
          npm ci

          # Setup Prisma
          npx prisma generate
          npx prisma migrate deploy || echo "Migration skipped (no DB needed for review)"

          # Start dev server in background
          npm run dev > dev-server.log 2>&1 &
          DEV_PID=$!
          echo $DEV_PID > dev-server.pid

          # Wait for server to be ready
          echo "Waiting for dev server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Dev server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Install Playwright browsers for MCP
          npx playwright install chromium

      - name: Claude Code Auto Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}

          prompt: |
            ${{ github.event_name == 'pull_request' && format('
            You are reviewing Pull Request #{0}: {1}

            Please perform the following tasks:

            1. **Run Tests**
               - Execute `npm run test`
               - If any tests fail, analyze the failures and fix them
               - Ensure all tests pass before proceeding

            2. **Run Linter**
               - Execute `npm run lint`
               - Fix any linting errors or warnings
               - Follow the existing code style

            3. **Type Check**
               - Run `npx tsc --noEmit`
               - Fix any TypeScript errors

            4. **Build Verification**
               - Run `npm run build`
               - Fix any build errors
               - Ensure the build completes successfully

            5. **UI Testing** (if applicable)
               - Open the app at localhost:3000 using Playwright
               - Take a snapshot to verify the UI loads
               - Test basic navigation and interactions
               - Verify no console errors appear

            6. **Code Review**
               - Review the changed files for:
                 * Code quality issues
                 * Security vulnerabilities
                 * Performance concerns
                 * Best practices violations
               - Suggest or implement improvements

            7. **Summary**
               - Provide a summary of what you found and fixed
               - List any remaining issues that need human review

            PR Details:
            - Author: {2}
            - Base Branch: {3}
            - Head Branch: {4}
            ', github.event.pull_request.number, github.event.pull_request.title, github.event.pull_request.user.login, github.event.pull_request.base.ref, github.event.pull_request.head.ref) || inputs.task || 'Review the code and fix any issues' }}

      - name: Commit Claude's fixes
        if: success()
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-code-bot@users.noreply.github.com"

          # Check if there are changes
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "ðŸ¤– Auto-fix by Claude Code

            Claude automatically reviewed and fixed issues in this PR:
            - Ran tests and fixed failures
            - Fixed linting errors
            - Resolved type errors
            - Verified build succeeds
            - Tested UI functionality

            Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push
            echo "âœ… Claude committed fixes"
          else
            echo "âœ… No fixes needed - everything looks good!"
          fi

      - name: Cleanup
        if: always()
        run: |
          # Stop dev server
          if [ -f dev-server.pid ]; then
            kill $(cat dev-server.pid) || true
            rm dev-server.pid
          fi

          # Show server logs if there were errors
          if [ -f dev-server.log ]; then
            echo "=== Dev Server Logs ==="
            tail -n 50 dev-server.log
          fi
