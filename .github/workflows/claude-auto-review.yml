name: Claude Auto Review & Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      task:
        description: 'Custom task for Claude to perform'
        required: false
        default: 'Review the code and fix any issues'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Project Setup
        run: |
          # Install dependencies
          npm ci

          # Setup Prisma
          npx prisma generate
          npx prisma migrate deploy || echo "Migration skipped (no DB needed for review)"

          # Start dev server in background
          npm run dev > dev-server.log 2>&1 &
          DEV_PID=$!
          echo $DEV_PID > dev-server.pid

          # Wait for server to be ready
          echo "Waiting for dev server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Dev server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Install Playwright browsers for MCP
          npx playwright install chromium

      - name: Claude Code Auto Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            ${{ github.event_name == 'pull_request' && format('
            You are reviewing Pull Request #{0}: {1}

            Please perform the following tasks:

            1. **Run Tests**
               - Execute `npm run test`
               - If any tests fail, analyze the failures and fix them
               - Ensure all tests pass before proceeding

            2. **Run Linter**
               - Execute `npm run lint`
               - Fix any linting errors or warnings
               - Follow the existing code style

            3. **Type Check**
               - Run `npx tsc --noEmit`
               - Fix any TypeScript errors

            4. **Build Verification**
               - Run `npm run build`
               - Fix any build errors
               - Ensure the build completes successfully

            5. **UI Testing** (if applicable)
               - Open the app at localhost:3000 using Playwright
               - Take a snapshot to verify the UI loads
               - Test basic navigation and interactions
               - Verify no console errors appear

            6. **Code Review**
               - Review the changed files for:
                 * Code quality issues
                 * Security vulnerabilities
                 * Performance concerns
                 * Best practices violations
               - Suggest or implement improvements

            7. **Summary**
               - Provide a summary of what you found and fixed
               - List any remaining issues that need human review

            PR Details:
            - Author: {2}
            - Base Branch: {3}
            - Head Branch: {4}
            ', github.event.pull_request.number, github.event.pull_request.title, github.event.pull_request.user.login, github.event.pull_request.base.ref, github.event.pull_request.head.ref) || inputs.task || 'Review the code and fix any issues' }}

          custom_instructions: |
            # UIGen Project Context

            ## Project Overview
            UIGen is an AI-powered React component generator with live preview.
            Users describe components in chat, and Claude generates code with immediate preview.

            ## Environment Setup
            - Node.js 20 is installed
            - All dependencies are installed via `npm ci`
            - Prisma client is generated and migrations are applied
            - Dev server is running at http://localhost:3000
            - Server logs are written to dev-server.log

            ## Available Commands
            - `npm run dev` - Start development server (already running)
            - `npm run build` - Build for production
            - `npm run lint` - Run ESLint
            - `npm run test` - Run Vitest tests
            - `npx tsc --noEmit` - Type check
            - `sqlite3 prisma/dev.db` - Query SQLite database

            ## Tools Available
            - **Bash**: For running commands (npm, git, etc.)
            - **File Tools**: Read, Edit, Write for code changes
            - **Playwright MCP**: Browser automation for UI testing
              * Use `mcp__playwright__browser_navigate` to open localhost:3000
              * Use `mcp__playwright__browser_snapshot` to see the page
              * Use `mcp__playwright__browser_click` to interact
              * Use `mcp__playwright__browser_console_messages` to check for errors

            ## Project Structure
            - `/src/app` - Next.js app router pages
            - `/src/components` - React components
            - `/src/lib` - Utilities, contexts, file system
            - `/src/actions` - Server actions
            - `/prisma` - Database schema and migrations

            ## Important Notes
            - This is a Next.js 14+ app using App Router
            - Uses Tailwind CSS for styling
            - Uses Prisma with SQLite for database
            - Virtual file system stores generated components in memory
            - Preview uses Babel for in-browser JSX transformation

            ## Code Standards
            - Use TypeScript strictly
            - Follow existing code patterns
            - Use comments sparingly (only for complex logic)
            - Prefer functional components with hooks
            - Use server actions for data mutations

          mcp_config: |
            {
              "mcpServers": {
                "playwright": {
                  "command": "npx",
                  "args": [
                    "@playwright/mcp@latest",
                    "--allowed-origins",
                    "localhost:3000;cdn.tailwindcss.com;esm.sh;cdn.jsdelivr.net;unpkg.com"
                  ]
                }
              }
            }

          allowed_tools: |
            Bash(npm:*),
            Bash(npx:*),
            Bash(node:*),
            Bash(git:*),
            Bash(sqlite3:*),
            Bash(curl:*),
            Bash(echo:*),
            Bash(cat:*),
            Bash(ls:*),
            Bash(pwd:*),
            Bash(grep:*),
            Read,
            Edit,
            Write,
            Glob,
            Grep,
            mcp__playwright__browser_navigate,
            mcp__playwright__browser_snapshot,
            mcp__playwright__browser_click,
            mcp__playwright__browser_type,
            mcp__playwright__browser_take_screenshot,
            mcp__playwright__browser_console_messages,
            mcp__playwright__browser_network_requests,
            mcp__playwright__browser_evaluate,
            mcp__playwright__browser_wait_for,
            mcp__playwright__browser_close,
            mcp__playwright__browser_tabs,
            mcp__playwright__browser_navigate_back

      - name: Commit Claude's fixes
        if: success()
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-code-bot@users.noreply.github.com"

          # Check if there are changes
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "ðŸ¤– Auto-fix by Claude Code

            Claude automatically reviewed and fixed issues in this PR:
            - Ran tests and fixed failures
            - Fixed linting errors
            - Resolved type errors
            - Verified build succeeds
            - Tested UI functionality

            Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push
            echo "âœ… Claude committed fixes"
          else
            echo "âœ… No fixes needed - everything looks good!"
          fi

      - name: Cleanup
        if: always()
        run: |
          # Stop dev server
          if [ -f dev-server.pid ]; then
            kill $(cat dev-server.pid) || true
            rm dev-server.pid
          fi

          # Show server logs if there were errors
          if [ -f dev-server.log ]; then
            echo "=== Dev Server Logs ==="
            tail -n 50 dev-server.log
          fi
